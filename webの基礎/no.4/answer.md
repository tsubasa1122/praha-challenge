## 課題 1

### クッキーとは何でしょうか？「Set-cookie」「ヘッダ」「サーバ」「ブラウザ」という単語を使って、クッキーの仕組みを説明してみてください

- ウェブサイトの情報をブラウザ側に保存する仕組みのことです。サーバがレスポンスで Set-Cookie ヘッダーを送信すると Cookie はブラウザ内に保存され、同じサーバに対してのリクエストと伴に Cookie ヘッダーの中で送信されます。値は key=value の形式で設定されます。

### www.hoge.comで発行されたクッキーは、www.fuga.comにも送信されるでしょうか？その理由を説明してください

- 送信されません。Cookie 発行時にクライアントから Cookie を送信する対象のサーバを指定する Domain 属性が設定され、オリジン(スキーム、ドメイン、ポート)が異なるドメインのサーバに対してブラウザは Cookie を送信しない仕様になっているためです。

### hoge.com:8080 のクッキーは hoge.com:9090 にも送信されるでしょうか？

- 送信されません。スキーム、ドメイン、ポートが全て一致しない限り同一オリジンとみなされず、同一オリジンにしかブラウザは Cookie を送信しないためです。

### www.hoge.com で発行されたクッキーは、www.api.hoge.com にも送信されるでしょうか？

- Cookie の Domain 属性の設定によって変わります。Cookie 発行時に、Domain 属性に何も指定しない場合は Cookie を発行先と同一オリジンのみとなり、サブドメインは除外されるが、Domain 属性を直接指定した場合、省略時よりも制限が緩和され、サブドメインに対しても Cookie を送信するようになるためです。

（例）www.api.hoge.comにもCookieを送信したい場合、以下のようにSet-CookieのDomainに設定を行います。

```
Set-Cookie: name=value; Domain=www.hoge.com;
```

### クッキーに Domain="hoge.com"を指定した場合、api.hoge.com にもクッキーは送信されるでしょうか？理由を説明してください

- 送信されます。Domain 属性を指定した場合、下位ドメインにまたがって Cookie を扱えるようになるためです。RFC 6265 の The Domain Attribute の項目にも記されています。[RFC6265](https://www.ietf.org/rfc/rfc6265.txt)

### ブラウザで実行される JavaScript は場合によってはクッキーの値を取得できます。JavaScript からクッキーの値が取得されることを防ぐことは可能でしょうか？どうすれば良いのでしょうか？

- 可能です。HttpOnly 属性を設定することで、JavaScript から Cookie の値を取得出来なくすることが出来ます。

（例）HttpOnly 属性を付けることで、user_session の値が JavaScript から取得出来なくなります。

```
Set-Cookie: user_session=ABCDE; HttpOnly
```

### HTTPS（暗号化）通信の時だけクッキーを送信することは可能でしょうか？どうすれば良いのでしょうか？

- 可能です。Secure 属性を設定することで、HTTPS 通信の時だけ Cookie を送信するようになります。※ URL に`http:`を含む、安全ではないサイトでは Secure 属性を使用出来ないため、注意が必要です。

（例）

```
Set-Cookie: user_session=ABCDE; Secure
```

### クッキーに Expires を設定すると、どのように挙動が変わるでしょうか？

- Cookie の有効期限が設定され、Expires に設定された日時を過ぎると Cookie が無効になります。※ 指定されなかった場合は、ブラウザのセッションが終了したタイミングで Cookie が無効になりますが、セッション復元機能を持つブラウザは Cookie を復元出来てしまうため、注意が必要です。

### SameSite 属性について説明してください

同じオリジンのドメインに対して Cookie を送信する仕組み。None, Lax, Strict の属性があります。

- None
  Cookie は全てのコンテキストで送信されるようになります。つまり、クロスオリジンの送信が許可されます。
  ※最近のモダンブラウザでは、デフォルトの SameSite が`None`から`Lax`に変わっており、クロスオリジンに対して Cookie を送信したい場合は明示的に`None`を設定し、Secure 属性を付ける必要がある。
  参考：[Chrome80 から SameSite のデフォルトが Lax になった](https://qiita.com/ahera/items/0c8276da6b0bed2b580c)

- Lax
  クロスオリジンのサイトからの POST,画像読み込み,XHR,iframe でのリクエストでは Cookie を発行したサイトでも Cookie を使用しない。GET であれば、Cookie を使用する。

- Strict
  どのようなリクエストがあっても、Cookie を発行したサイト以外で Cookie を使用しないようになります。

### クッキーに格納しない方が良い情報の例を、3 つ以上挙げてください

- ユーザー ID や権限情報
  Cookie はブラウザで値を書き換えることが容易に出来てしまうため、権限外の操作や情報閲覧が出来てしまう恐れがあります。

- 推測可能なセッション ID
  Cookie はブラウザ上で閲覧・書き換えが容易に出来てしまうため、推測可能なセッション ID を格納してしまうと他のユーザーになりすましが出来てしまう恐れがあります。

- 容量が大きなデータ
  Cookie の保存容量が最大 4096 バイトとなっているため、LocalStorage に比べて多くのデータを保存することが出来ません。また、サーバーへの通信時には Cookie が毎回送信されるので、Cookie のデータ量が増えてしまうと、その分通信に影響してしまいます。

- 削除されたら困るデータ
  Cookie はブラウザの設定やユーザ側で自由に削除出来たり、有効期限があるため、データを永続化するにはサーバ側で処理を行う必要があります。

### クッキーはローカルストレージと混同されることが多々あります。クッキーを使うべきタイミングと、ローカルストレージを使うべきタイミングを挙げてみてください

#### Cookie を使うべきタイミング

- セッション ID などの一時的なユーザーのログイン情報を、よりセキュアに管理したいとき。（ローカルストレージに比べて、JS での操作を防いだり HTTPS のみの送信にしたり SameSite への制御などの設定を行うことが出来るため。）
- ユーザーのパーソナライゼーションを行いたいとき。（ブラウザ毎に１つの Cookie が発行されるので、上記のセッション ID や User-Agent を用いることで、より詳細なユーザーの特定が出来るため。）
- ユーザー情報をトラッキングしたいとき。（Cookie はサーバーにリクエストするときに毎回送信されるため、ユーザー情報のトラッキングには適している。）

#### ローカルストレージを使うべきタイミング

- 5MB と Cookie に比べて保存出来るデータの容量が大きく、明示的に削除するまでデータを永続化することが出来、データ利用時のみサーバーへのデータを送信することが出来るため、フロント側のロジックの保持などを行うためにブラウザ側で容量が大きなデータを保持しておきたいときに利用すると良い。

### stack overflow のような WEB 掲示板サービスを開発しているとしましょう。XSS（クロスサイトスクリプティング）により、他ユーザのクッキー情報が抜き出される仕組みを説明してください。どのような対策が考えられますか？

悪意のあるユーザーが掲示板の投稿に Cookie 情報を抜き出す Script を仕込んで投稿することで、その投稿にユーザーがアクセスすると Script が実行され Cookie の情報が抜き出されてしまう。

#### 対策

- Cookie を JS から操作出来ないように HttpOnly 属性を付ける。
- ウェブページに出力する全ての要素に対して、エスケープ処理(サニタイジング)を施す。
- 属性値を引用符で囲む。

```
○ <input type="text" value="$data">
× <input type="text" value=$data>
```

- href, rel, src などの属性値にユーザデータを指定する場合は、URL のスキームをチェックする。
- 入力された HTML テキストから、スクリプトに該当する文字列を排除する。(HTML の入力を許可した場合)

参考：
https://www.ipa.go.jp/security/vuln/websecurity-HTML-1_5.html
http://www.tohoho-web.com/ex/xss.html

## 課題 2（クイズ）

No.1：XSS の 3 つの攻撃手法のひとつである反射型 XSS (Refrected XSS)は具体的にはどのような攻撃手法なのか説明しなさい。

No.2：下記のオブジェクトを JSON 文字列で localStorage に保存し、JSON データとして localStorage から取得し、localStorage からデータを削除する一連の処理を記載しなさい。※Storage に保存する Item の key 名は"user"にしてください。

```
const user = {name: "Tom", age: 28}

```

No.3：Cookie の Path 属性はどのような役割を持つでしょうか？
