# 課題１（質問）

### expand and contract pattern とは？

- 書籍「データベース・リファクタリング」にて説明されているリファクタリングパターンのこと
  - `移行開始時と移行終了時の2つのタイミングをもち、移行中は古い状態と新しい状態の両方を維持します。それによって、移行状態では後方互換性を維持でき、他のシステムが変更に追いつくための十分な時間を与えます。`
  - 古いスキーマに依存するアプリケーションがある時に、まずは新しいカラムを追加( `expand` )します。古い定義と新しい定義を共存させる状態を一時的に作り、アプリケ＝ション側で依存している箇所を新しいカラム側に移行してから古いカラムを削除( `contract` )することで、安全にスキーマをリファクタリングする方法
  - https://syobochim.hatenablog.com/entry/2020/05/20/084736 の記事が分かりやすかった
  - ORM を使っているサービスだと、デプロイ時にカラムを削除する際、アプリケーション側のスキーマの定義と DB のテーブルの内容に差異がある状態が一時的に生まれます。そのタイミングで、リクエストを受けるとアプリケーションが死ぬので、アプリケーション側で削除予定のカラムを ignore しておくとより安全
    - Rails だと、`ignored_columns`というメソッドが用意されている
    - prisma だと、[@ignore](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#ignore) が使えそうかな？

### 本番環境で NOT NULL 制約のエラーが出る原因

- 本番環境で作成されているデータの中に、値が NULL のレコードが存在するから
  - 開発環境では、データ量が少ないので migration が成功しても、本番環境ではどんなデータが作成されているかちゃんと確認する必要がある
  - また、既存のテーブルに新しくカラムを追加する場合でも、すでに作成済みのレコードに対しても変更が掛かるため、同様にエラーが出るので注意が必要

**対策**

- 事前に本番データを確認し、レコードに NULL が含まれていないことをチェックする
  - チェックしていても完璧ではないことは意識しておく
    - migration 直前に NULL のレコードが生成されてしまう可能性がある
- migration の際に値が NULL だったら仮の値を入れる処理を加える

課題２（実装）

マイグレーションに限らず本番環境で何らかの作業を行う際は作業手順書を作成しておくことが多いでしょう。 自分以外の開発者でも実行できるように丁寧に手順を書き出すのみならず、事前に想定し得る問題を列挙して、いざ問題が発生したときの対応手順を書き出しておくと安心です。何か不具合が起きて、怒鳴られたり対応を急かされながら対応策を考えると余計にミスをしてしまうので...
特大課題でモデリングしたプラハチャレンジのアプリケーションに仕様変更があり、ユーザが複数のペアに所属できるようになりました
この作りに対応するためにはデータベースのスキーマを変更する必要がありそうです
マイグレーションの作業手順書を作成してください。最低限以下の点を抑えておきましょう！
実行手順をステップごとに細かく列挙
例：本番環境で実行するコマンドは作業手順書からコピペするだけで完結するような状態になっていると良いですね！（コピペしたコマンドを全て開発環境で一度実行して動作確認まで済ませていると最高）
発生しうる問題
問題が発生したときの対応策
使うツールは問いません。HackMD でも notion でも！
上記以外に、どのような情報を手順書に残しておくと良いでしょうか?
