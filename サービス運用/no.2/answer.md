# 課題１（質問）

### expand and contract pattern とは？

- 書籍「データベース・リファクタリング」にて説明されているリファクタリングパターンのこと
  - `移行開始時と移行終了時の2つのタイミングをもち、移行中は古い状態と新しい状態の両方を維持します。それによって、移行状態では後方互換性を維持でき、他のシステムが変更に追いつくための十分な時間を与えます。`
  - 古いスキーマに依存するアプリケーションがある時に、まずは新しいカラムを追加( `expand` )します。古い定義と新しい定義を共存させる状態を一時的に作り、アプリケ＝ション側で依存している箇所を新しいカラム側に移行してから古いカラムを削除( `contract` )することで、安全にスキーマをリファクタリングする方法
  - https://syobochim.hatenablog.com/entry/2020/05/20/084736 の記事が分かりやすかった
  - ORM を使っているサービスだと、デプロイ時にカラムを削除する際、アプリケーション側のスキーマの定義と DB のテーブルの内容に差異がある状態が一時的に生まれます。そのタイミングで、リクエストを受けるとアプリケーションが死ぬので、アプリケーション側で削除予定のカラムを ignore しておくとより安全
    - Rails だと、`ignored_columns`というメソッドが用意されている
    - prisma だと、[@ignore](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#ignore) が使えそうかな？

### 本番環境で NOT NULL 制約のエラーが出る原因

- 本番環境で作成されているデータの中に、値が NULL のレコードが存在するから
  - 開発環境では、データ量が少ないので migration が成功しても、本番環境ではどんなデータが作成されているかちゃんと確認する必要がある
  - また、既存のテーブルに新しくカラムを追加する場合でも、すでに作成済みのレコードに対しても変更が掛かるため、同様にエラーが出るので注意が必要

**対策**

- 事前に本番データを確認し、レコードに NULL が含まれていないことをチェックする
  - チェックしていても完璧ではないことは意識しておく
    - migration 直前に NULL のレコードが生成されてしまう可能性がある
- migration の際に値が NULL だったら仮の値を入れる処理を加える

# 課題２（実装）

- migration の手順書を書く機会あるのかな？
  - 基本的に CI で自動化されていることが多いので...

### 手順書

- 実行手順

本番環境に SSH する

```
$ ssh -i ${}.pem ${サーバー名}

# アプリケーション配下へ移動する
$ cd path/to/${app name}
```

※ データに変更を加える場合は事前にバックアップを取ること

```
# dump or コンソール上でスナップショットを撮る
$ mysqldump -u USER_NAME -p -h HOST_NAME DB_NAME > OUTPUT_FILE_NAME
```

migration の実行

```
$ npx prisma migrate deploy
```

PrismaClient へのスキーマの変更反映

```
$ npx prisma generate
```

**トラブルシューティング**
もし migration に失敗してロールバックしたい場合

```
# 事前にロールバックが可能かテストしておくこと
$ npx prisma migrate down ${戻したいmigrationのステップ数} --experimental
```

データ復元したい場合

```
$ mysql -u username -ppassword -D DBname < dumpfilename.sql
```

### どのような情報を手順書に残しておくと良いでしょうか?

- スクリプト毎にエラー時の対応方法を書いておくと良さそう
  - 失敗した際に、アプリケーションを前のバージョンに戻す or 不具合があるデータを手動で対応する or そのまま GO!GO!
  - アプリケーションを前のバージョンに戻す方法も手順に追加する
- もし直前にデータの内容を更新する場合は、ログを確認しながら実行する手順を追加する
  - 実際にエラーが出てないか確認しながら作業する
- データ更新後の確認方法
  - `Rails Console`で値が変更されていることを確認するイメージ
