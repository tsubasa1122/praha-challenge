# 課題１（質問）

### ログレベルとは？

- 生成するログの詳細度を示すもので、ログに出力される情報量が変わる
  - パフォーマンスにも大きく影響する

**レベル**

- Rails だと、`:debug`, `:info`, `:warn`, `:error`, `:fatal`, `:unknown`を設定することができる

  - ログレベルは debug < info < warn < error < fatal < unknown の順に高くなる
  - 設定したレベル以上のログ情報が出力されるようになる
  - production 環境 だと、`:info`や`:warn`、development 環境だと`:debug`を設定する場合が多い
  - `:debug`を設定するとデバッグに役立つ詳細なメッセージを出力するようになる(ex. クエリログや処理を行なったファイルのトレースなど)

#### メモ

- ざっくりとログレベルは以下のようなイメージ

```
debug	開発者向けの情報(クエリログや処理を行なったファイルのトレースなど)
info	システム操作や、管理に役立つ情報(外部からのリクエスト内容やレスポンスのHTTP Statusなど)
warn	警告、アプリケーションは提供できるが対応が望まれる
error	ユーザーのリクエストが処理できない
fatal	致命的なエラーで、アプリケーション全体が提供できない
```

参考:  
https://dzone.com/articles/rails-logger-and-rails-logging-best-practices  
https://morizyun.github.io/ruby/rails-function-rails-logger.html

**ログレベルのメリット**

- 環境に応じて必要なログを出力することができる
  - 開発環境では、デバッグするためにアプリケーションの詳細なログ情報が欲しい
  - 本番環境では、パフォーマンスやセキュリティの観点から必要最低限のログ情報だけが欲しい

### アプリケーションログにはどのような情報を含めるべきでしょうか？

- アプリケーションの正常な動作の記録

  - 処理されたリクエスト・リダイレクトされたリクエスト・外部 API へのリクエスト
    - 処理日時
    - ユーザー ID などのアクセス元情報
    - 操作結果(成功 or 失敗)
    - 処理されたイベントの id
      - マイクロサービス構成にしている場合は一連の操作を関連付けるために使用する
    - URL
    - パラメーター
    - 処理結果
      - HTTP 200~

- 発生したエラーの記録
  - クライアントエラー/サーバーエラーに関するリクエスト
  - backtrace 情報など
- アプリケーションのメトリクスや問題が起こった時に原因を特定するために必要な情報を出力する
- サービスの特性の KPI を調査するための数値を出力する

参考:  
https://blog.mmmcorp.co.jp/blog/2018/05/25/web_application_logging/  
https://qiita.com/nanasess/items/350e59b29cceb2f122b3  
https://applis.io/posts/how-to-design-log-output

**含めない方が良い情報**

- セキュリティに関わる情報
  - パスワードや個人情報
  - OAuth などの認証情報

### どのようなタイミング？

- (info)正常系の処理が終了したとき
- (warn)特定の処理が実行されたとき(不具合調査のために、独自に設定する)
- (error)例外が生じたとき(エラーは出るがサービスは動いている状態)
- (fatal)サービス全体に関わるエラー(例えば、DB とコネクションできないなど)

### ログを全て人力で検査するのは大変なので、スクリプトなどで集計しやすいように、パースしやすいメッセージを作ることも大切だと言われます。どのようなログメッセージならパースしやすくなるでしょうか？

- DataDog は以下のログフォーマットに対応している
  - JSON
  - GLog
    - kubernetes で出力されることがあるらしい。Google logging
  - XML
  - CSV
- 基本的には key:value でログを構造化させる
- 前職では LTSV 形式のログを出力することがあった
  - https://naoya-2.hatenadiary.org/entry/20130209/1360381374
  - 基本的には JSON で良さそう
- Rails だと Lograge とかを使って構造化する
  - https://github.com/roidrage/lograge

### ログの種類

**アクセスログ**

- クライアントからのリクエストの内容を記録したもの
  - 各サーバーで出力する
  - DB のアクセスログはあんまり考えたことなかったが必要そう
  - アプリケーションで出力する際はロードバランサーの ip を出力してしまわないように注意が必要
- ここでの質問はロードバランサーへのアクセスのログという意味？

**アプリケーションログ**

- アプリケーションの動作状況を記録したもの

**エラーログ**

- システムにエラーが発生した際の内容を記録したもの
  - アプリケーションログに含まれるものだと認識していたが違うのかな？

**（フロントエンドの）ユーザーログ**

- A/B テスト等を通じて機能開発に対する分析を行うための情報を記録したもの
  - https://engineer.retty.me/entry/2018/12/01/120019
  - Google Tag Manager とかかな？
    - あってた
  - 各社どんな感じで実装しているのか気になる
    - データの集計は GTM などの外部サービスを利用している or 自前実装
    - フロント側でデータを記録・計算する処理は具体的にどんな感じにしている？
      - 個別に実装するのはつらそうなので...

**データベースのクエリログ**

- クライアント(application)から実行された全ての SQL クエリを記録したもの

### ログローテーションとは

- ログが際限なく増えることを防ぐために、一定の容量や期間ごとに古いログを削除したり新しいログで上書きする仕組み
  - アプリケーション側 or OS 側で設定することができる
  - ローテーションすることで、サーバーのディスク領域を使い切ってしまわないようにすることができる
    - 容量を使い切ってしまうと、ログが書き込めないことでサーバーが機能停止になる恐れがある

参考:  
https://e-words.jp/w/%E3%83%AD%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3.html  
https://qiita.com/matsuda-hiroki/items/9802538432b9dbf03ab0
